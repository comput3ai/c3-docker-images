# Stage 1: Initialize and download models
FROM ollama/ollama AS model-downloader

# Copy initialization script
COPY <<EOF /init-models.sh
#!/bin/bash
set -e

# Start ollama in the background
ollama serve &
OLLAMA_PID=\$!

# Wait for ollama to start
sleep 10

# Function to download and rename a model
download_model() {
    original_model=\$1
    final_name=\$2
    echo "Downloading \$final_name ..."
    ollama pull \$original_model > /dev/null 2>&1 && \
    ollama cp \$original_model \$final_name && \
    ollama rm \$original_model
}

# Start all downloads in parallel
download_model llama3.3:70b-instruct-q4_0 llama3:70b &
PID1=\$!
download_model hermes3:70b-llama3.1-q4_0 hermes3:70b &
PID2=\$!
download_model llama3.1:8b-instruct-q8_0 llama3:8b &
PID3=\$!
download_model hermes3:8b-llama3.1-q8_0 hermes3:8b &
PID4=\$!
download_model llama3.2:3b-instruct-q8_0 llama3:3b &
PID5=\$!
download_model hermes3:3b-llama3.2-q8_0 hermes3:3b &
PID6=\$!

# Wait for all processes
wait \$PID1 \$PID2 \$PID3 \$PID4 \$PID5 \$PID6

# Shutdown ollama
kill \$OLLAMA_PID
sleep 5
EOF

RUN chmod +x /init-models.sh
# Run the initialization script
RUN /init-models.sh

# Stage 2: Final image
FROM ollama/ollama

# Add non-root user
RUN groupadd -r -g 65532 ollama && \
    useradd -r -m -u 65532 -g ollama ollama

# Copy the model data from the downloader stage
COPY --from=model-downloader /root/.ollama /home/ollama/.ollama

# Set permissions
RUN chown -R ollama:ollama /home/ollama/.ollama && \
    chmod -R 750 /home/ollama/.ollama

USER 65532:65532